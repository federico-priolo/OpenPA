000010  INIZIO-WEB.
000020
000030      CALL  "COBW3_INIT"      USING  COBW3 .
000040
000050* SET the CONTENT-TYPE to HTML
000060      SET COBW3-CONTENT-TYPE-HTML TO TRUE .
000070
000080* COMMENTARE PER DISATTIVARE IL DEBUG NATIVO
000090      MOVE "1"             TO COBW3-DMODE.
000100
000110  EX-INIZIO-WEB.
000120        EXIT.
000130
000140
000150  FINE-WEB.
000160
000170      CALL  "COBW3_FREE"       USING  COBW3 .
000180
000190  EX-FINE-WEB.
000200        EXIT.
000210
000220  LETTURA-WEB.
000230
000240         IF NOT OPENED-WEB
000250          OPEN INPUT ARKWEB
000260           SET OPENED-WEB    TO TRUE
000270           MOVE "N"          TO EOF-WEB
000280           IF STATUS-WEB NOT = "00"
000290           STRING " ERRORE APERTURA " FILE-WEB
000300            DELIMITED BY SIZE INTO MESSAGGIO
000310            PERFORM VIS-MESS  THRU EX-VIS-MESS
000320             GO TO END-LETTURA-WEB.
000330
000340          READ ARKWEB NEXT RECORD AT END
000350           GO TO END-LETTURA-WEB.
000360
000370          IF DATI-WEB = SPACES GO TO LETTURA-WEB.
000380
000390          PERFORM REPLACE-WEB THRU EX-REPLACE-WEB.
000400
000410          PERFORM LINE-WEB    THRU EX-LINE-WEB.
000420
000430
000440          GO TO EX-LETTURA-WEB.
000450
000460  END-LETTURA-WEB.
000470
000480          SET EOF-FILE-WEB  TO TRUE.
000490          MOVE SPACE        TO FLAG-WEB.
000500
000510          CLOSE ARKWEB.
000520
000530  EX-LETTURA-WEB.
000540          EXIT.
000550
000560
000570  VIS-MESS.
000580
000590          MOVE MESSAGGIO      TO VALUE-WEB.
000600          MOVE "MK-MESSAGE"   TO FIELD-WEB.
000610          PERFORM METTI-WEB   THRU EX-METTI-WEB.
000620
000630          MOVE "SEGNALAZIONE" TO VALUE-WEB.
000640          MOVE "MK-TITLE"     TO FIELD-WEB.
000650          PERFORM METTI-WEB   THRU EX-METTI-WEB.
000660
000670          MOVE SECTION-WEB    TO VALUE-WEB.
000680          MOVE "MK-KEY"       TO FIELD-WEB.
000690          PERFORM METTI-WEB   THRU EX-METTI-WEB.
000700
000710
000720			MOVE "GOBACK"		TO NOME-VIEW.
000730			PERFORM LEGGO-VIEW	THRU EX-LEGGO-VIEW.
000740			IF ESITO-NOK MOVE SPACES TO STRINGA-VIEW.
000750
000760          MOVE STRINGA-VIEW   TO VALUE-WEB.
000770          MOVE "MK-BACK"      TO FIELD-WEB.
000780          PERFORM METTI-WEB   THRU EX-METTI-WEB.
000790
000800
000810
000820          MOVE "TEMPLATE/MESSAGE.HTM"  TO PAGE-WEB.
000830          PERFORM SHOW-WEB    THRU EX-SHOW-WEB.
000840
000850  EX-VIS-MESS.
000860          EXIT.
000870
000880  VIS-MENU.
000890
000900          MOVE MESSAGGIO      TO VALUE-WEB.
000910          MOVE "MK-MESSAGE"   TO FIELD-WEB.
000920          PERFORM METTI-WEB   THRU EX-METTI-WEB.
000930
000940          MOVE "SEGNALAZIONE" TO VALUE-WEB.
000950          MOVE "MK-TITLE"     TO FIELD-WEB.
000960          PERFORM METTI-WEB   THRU EX-METTI-WEB.
000970
000980          MOVE SECTION-WEB    TO VALUE-WEB.
000990          MOVE "MK-KEY"       TO FIELD-WEB.
001000          PERFORM METTI-WEB   THRU EX-METTI-WEB.
001010
001020
001030          MOVE "TEMPLATE/GOMENU.HTM"  TO PAGE-WEB.
001040          PERFORM SHOW-WEB    THRU EX-SHOW-WEB.
001050
001060  EX-VIS-MENU.
001070          EXIT.
001080
001090  VIS-LOGIN.
001100
001110          move spaces to messaggio
001120
001130          string "Utente non presente o sessione di lavoro"
001140           " e' scaduta  - e' necessario rifare "
001150           " la login" DELIMITED BY SIZE INTO messaggio
001160          MOVE MESSAGGIO      TO VALUE-WEB.
001170          MOVE "MK-MESSAGE"   TO FIELD-WEB.
001180          PERFORM METTI-WEB   THRU EX-METTI-WEB.
001190
001200          MOVE "SEGNALAZIONE" TO VALUE-WEB.
001210          MOVE "MK-TITLE"     TO FIELD-WEB.
001220          PERFORM METTI-WEB   THRU EX-METTI-WEB.
001230
001240
001250
001260          MOVE "TEMPLATE/GOLOGIN.HTM"    TO PAGE-WEB.
001270          PERFORM SHOW-WEB    THRU EX-SHOW-WEB.
001280
001290  EX-VIS-LOGIN.
001300          EXIT.
001310
001320
001330  METTI-WEB.
001340
001350          MOVE FIELD-WEB    TO COBW3-CNV-NAME.
001360          MOVE VALUE-WEB    TO COBW3-CNV-VALUE.
001370          MOVE ZEROS        TO COBW3-CNV-NAME-LENGTH.
001380          MOVE ZEROS        TO COBW3-CNV-VALUE-LENGTH.
001390          CALL "COBW3_CNV_SET" USING COBW3.
001400          MOVE SPACES       TO COBW3-CNV-VALUE.
001410
001420  EX-METTI-WEB.
001430          EXIT.
001440
001450
001460  SHOW-WEB.
001470
001480          MOVE PAGE-WEB     TO COBW3-HTML-FILENAME.
001490          CALL "COBW3_PUT_HTML" USING COBW3.
001500
001510  EX-SHOW-WEB.
001520          EXIT.
001530
001540  LINE-WEB.
001550
001560          IF DATI-WEB > SPACES
001570          MOVE DATI-WEB       TO     COBW3-PUT-STRING
001580          MOVE ZEROS          TO     COBW3-PUT-STRING-LENGTH
001590          CALL  "COBW3_PUT_TEXT"   USING  COBW3
001600
001610          MOVE SPACES             TO DATI-WEB.
001620
001630  EX-LINE-WEB.
001640          EXIT.
001650
001660
001670  READ-WEB.
001680
001690        IF INDEX-WEB NOT > 1
001700          MOVE 1          TO  COBW3-NUMBER
001710         ELSE
001720          MOVE INDEX-WEB TO  COBW3-NUMBER.
001730
001740        MOVE FIELD-WEB   TO  COBW3-SEARCH-DATA
001750        CALL "COBW3_NAME" USING COBW3
001760        MOVE COBW3-GET-DATA (1:COBW3-GET-LENGTH) TO VALUE-WEB.
001770
001780        IF  COBW3-SEARCH-FLAG-EXIST
001790         SET ON-WEB TO TRUE
001800         ELSE
001810         SET OFF-WEB TO TRUE.
001820
001830         IF VALUE-WEB(1:2) NUMERIC
001840          AND VALUE-WEB(3:1) = "/"
001850           AND VALUE-WEB(4:2) NUMERIC
001860            AND VALUE-WEB(6:1) = "/"
001870             AND VALUE-WEB(7:4) NUMERIC
001880
001890             MOVE VALUE-WEB(1:2) TO GG-WEB
001900             MOVE VALUE-WEB(4:2) TO MM-WEB
001910             MOVE VALUE-WEB(7:4) TO AA-WEB
001920              ELSE
001930              INITIALIZE DATA-WEB.
001940
001950
001960          PERFORM ALFA-TO-NUM-WEB THRU EX-ALFA-TO-NUM-WEB.
001970
001980
001990  EX-READ-WEB.
002000          EXIT.
002010
002020  MAKE-WEB.
002030
002040          MOVE PAGE-WEB TO FILE-WEB.
002050          MOVE "N"      TO EOF-WEB.
002060          PERFORM UNTIL EOF-FILE-WEB
002070          PERFORM LETTURA-WEB THRU EX-LETTURA-WEB
002080          END-PERFORM.
002090
002100  EX-MAKE-WEB.
002110          EXIT.
002120
002130  CALL-WEB.
002140
002150          CALL "POWEROPENSHEET" USING PROGRAMMA-WEB
002160                                      LIBRERIA-WEB
002170                          RETURNING RITORNO-WEB.
002180
002190
002200  EX-CALL-WEB.
002210          EXIT.
002220
002230  REPLACE-STANDARD-WEB.
002240
002250
002260          MOVE SPACES     TO FILE-LIB
002270
002280          MOVE ZEROS TO IND1-WEB IND-WEB.
002290*
002300*** separatori ammesssi @varibile@   diventa 'varibile'
002310*
002320*** separatori ammesssi $varibile$   diventa  varibile
002330*
002340          INSPECT DATI-WEB TALLYING IND1-WEB FOR ALL "@"
002350
002360          MOVE SPACES     TO FILE-LIB
002370
002380          IF IND1-WEB  = 2
002390          MOVE SPACES     TO NOME-VIEW
002400           unstring DATI-WEB DELIMITED BY "@"
002410            INTO DUMMY NOME-VIEW FILE-LIB
002420              GO TO LETTURA-STANDARD-WEB.
002430
002440  CICLO-DOLLARO-WEB.
002450  
002460          MOVE ZEROS TO IND-WEB.
002470
002480          INSPECT DATI-WEB TALLYING IND-WEB FOR ALL "$"

002490**** COPPIE DI $ DEFINISCONO UNA VARIABILE

002500          IF IND-WEB  < 2 GO TO EX-REPLACE-STANDARD-WEB.
002510
002520          MOVE SPACES TO NOME-VIEW.
002530
002540          PERFORM VARYING IND-WEB FROM 1 BY 1 UNTIL 
002550          IND-WEB > LENGTH OF DATI-WEB OR DATI-WEB(IND-WEB:1) = "$"
002560           CONTINUE
002570          END-PERFORM
002580          
002590          MOVE  IND-WEB TO IND1-WEB.
002600                          
002610          ADD 1  TO IND1-WEB.
002620          
002630          MOVE ZERO TO SIZE-WEB.
002640          
002650          PERFORM VARYING IND1-WEB FROM IND1-WEB BY 1 UNTIL 
002660          IND1-WEB > LENGTH OF DATI-WEB OR DATI-WEB(IND1-WEB:1) = "$"
002670          
002680           ADD 1    TO SIZE-WEB
002690           
002700          END-PERFORM
002710          
002720          
002730          
002740***** SALVA DA DOPO IL 2 $ $VARIABILE$->------ IN BUFFER 
002750
002751			COMPUTE IND2-WEB = IND1-WEB + 1
002752
002760          MOVE DATI-WEB(IND2-WEB:) TO BUFFER
002761
002762			COMPUTE IND2-WEB = IND-WEB + 1
002763
002770          
002780          MOVE DATI-WEB(IND2-WEB:SIZE-WEB)  TO NOME-VIEW
002790          
002800          PERFORM LEGGO-VIEW THRU EX-LEGGO-VIEW.
002810
002820          IF ESITO-NOK MOVE  SPACES TO EDIT-VIEW.
002830              
002840          MOVE EDIT-VIEW  TO DATI-WEB(IND-WEB:)

                PERFORM VARYING IND-WEB FROM LENGTH OF DATI-WEB 
                  BY -1 UNTIL DATI-WEB(IND-WEB:1) > SPACES      
                  CONTINUE
                END-PERFORM
                
                ADD 1 TO IND-WEB
                
                MOVE "/DIVISORE/" TO DATI-WEB(IND-WEB:)
002850          
002860          MOVE SPACES     TO BUFFER1
002870          
002880          STRING DATI-WEB DELIMITED BY "/DIVISORE/"
002890              BUFFER DELIMITED BY SIZE INTO BUFFER1
002900              
002910          MOVE BUFFER1    TO  DATI-WEB.
002920          
002930          GO TO CICLO-DOLLARO-WEB.
002940
002950  LETTURA-STANDARD-WEB.
002960
002970**** SE PRESENTE UN FILE LIBRERIA DESUME LA STRUTTURA DAL RELATIVO FILE NEL QUALE SOSTITUISCE @DATA@ CON LA VARIABILE...
002980*
002990*       @VARIABILE@FILE=/TEMPLATE/FILE.LIB
003000*
003010
003020
003030          PERFORM PREPARA-WEB   THRU EX-PREPARA-WEB.
003040
003050          IF FILE-LIB(1:5) = "FILE="
003060			 MOVE FILE-LIB(6:)    TO LIBRERIA-WEB
003070			  MOVE LIBRERIA-WEB   TO FILE-LIB
003080             PERFORM TRATTA-LIB THRU EX-TRATTA-LIB.
003090
003100
003110
003120  EX-REPLACE-STANDARD-WEB.
003130          EXIT.
003140
003150  PREPARA-WEB.
003160*
003170**  SE NOME UGUALE AD INCLUDE ALLORA C'E UN @INCLUDE@FILE=/TEMPLATE/FILE.HTM CHE VIENE CARICATO
003180*			
003190
003200
003210          PERFORM LEGGO-VIEW THRU EX-LEGGO-VIEW.
003220
003230          IF ESITO-NOK MOVE  SPACES TO EDIT-VIEW.
003240
003250          MOVE SPACES        TO BUFFER.
003260
003270          STRING "             '" DELIMITED BY SIZE
003280          EDIT-VIEW  DELIMITED BY "             "
003290           "'" DELIMITED BY SIZE INTO BUFFER
003300           MOVE BUFFER           TO DATI-WEB.
003310
003320
003330  EX-PREPARA-WEB.
003340          EXIT.
003350
003360
003370  LETTURA-LIB.
003380
003390         IF NOT OPENED-LIB
003400          OPEN INPUT ARKLIB
003410           SET OPENED-LIB    TO TRUE
003420           MOVE "N"          TO EOF-LIB
003430           IF STATUS-LIB NOT = "00"
003440           STRING " ERRORE APERTURA " FILE-LIB
003450            DELIMITED BY SIZE INTO MESSAGGIO
003460            PERFORM VIS-MESS  THRU EX-VIS-MESS
003470             GO TO END-LETTURA-LIB.
003480
003490          READ ARKLIB NEXT RECORD AT END
003500           GO TO END-LETTURA-LIB.
003510
003520          IF DATI-LIB = SPACES GO TO LETTURA-LIB.
003530
003540          MOVE ZEROS          TO IND-LIB.
003550
003560          INSPECT DATI-LIB TALLYING IND-LIB FOR ALL "@DATA@"
003570
003580          IF IND-LIB  = 1
003590           MOVE BUFFER        TO DATI-LIB.
003600
003610          MOVE ZEROS          TO IND-LIB.
003620
003630          INSPECT DATI-LIB TALLYING IND-LIB FOR ALL "@"
003640
003650          IF IND-LIB  = 2
003660           MOVE DATI-LIB      TO DATI-WEB 
003670			  PERFORM REPLACE-STANDARD-WEB THRU EX-REPLACE-STANDARD-WEB
003680            PERFORM LINE-WEB    THRU EX-LINE-WEB
003690				GO TO LETTURA-LIB.
003700
003710
003720          MOVE DATI-LIB       TO DATI-WEB.
003730
003740          PERFORM LINE-WEB    THRU EX-LINE-WEB.
003750
003760
003770          GO TO LETTURA-LIB.
003780
003790  END-LETTURA-LIB.
003800
003810          SET EOF-FILE-LIB  TO TRUE.
003820          MOVE SPACE        TO FLAG-LIB.
003830
003840          CLOSE ARKLIB.
003850
003860  EX-LETTURA-LIB.
003870          EXIT.
003880
003890
003900  TRATTA-LIB.
003910
003920          MOVE "N"      TO EOF-LIB.
003930          PERFORM UNTIL EOF-FILE-LIB
003940          PERFORM LETTURA-LIB THRU EX-LETTURA-LIB
003950          END-PERFORM.
003960
003970  EX-TRATTA-LIB.
003980          EXIT.
003990
004000
004010  ALFA-TO-NUM-WEB.
004020
004030
004040          MOVE ALL ZEROS          TO TAB-NUMERO-WEB.
004050
004060          MOVE 18                 TO IND3-WEB
004070          PERFORM VARYING IND2-WEB FROM 18 BY -1 UNTIL IND2-WEB = ZERO
004080
004090          IF VALUE-WEB(IND2-WEB:1) NUMERIC
004100          MOVE  VALUE-WEB(IND2-WEB:1)   TO TAB-NUMERO-WEB(IND3-WEB:1)
004110          SUBTRACT 1 FROM IND3-WEB
004120          END-IF
004130
004140          END-PERFORM.
004150
004160          MOVE TAB-NUMERO-WEB     TO NUMERO-WEB.
004170
004180
004190  EX-ALFA-TO-NUM-WEB.
004200          EXIT.
